<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>habit-track</title>
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs" defer></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/static/service-worker.js");
    }
  </script>
</head>
<body x-data="{
  dark: false,
  mood: {{ mood or 3 }},
  showModal: false,
  form: { habit: '', label: '', duration: 15, note: '' }
}" :class="{ 'dark': dark }">

  <header>
    <h1>🌿 habit-track (Web UI)</h1>
    <div class="controls">
      <button @click="dark = !dark" class="theme-toggle">
        🌗 Toggle {{ dark ? 'Light' : 'Dark' }} Mode
      </button>
      <a href="/export" class="button">📥 Export as CSV</a>
      <a href="/analytics" class="button">📊 Analytics</a>
      <a href="/settings" class="button">⚙️ Settings</a>
      <button onclick="window.print()" class="button">🖨️ Print View</button>
    </div>
  </header>

  <!-- Summary Tiles -->
  <section class="summary-tiles">
    {% for key, info in stats.items() %}
      <div class="tile">
        <h3>{{ info.label }}</h3>
        <p>🔥 Streak: <strong>{{ info.streak }}</strong></p>
        <p>⏱️ Avg: <strong>{{ info.avg_duration }} min</strong></p>
      </div>
    {% endfor %}
  </section>

  <!-- Weekly Habit Grid -->
  <section>
    <h2>🗓️ Weekly Habit Grid</h2>
    <div id="habit-grid">
      {% include "_habit_row.html" %}
    </div>
  </section>

  <!-- Mood Tracker -->
  <section class="mood-block">
    <h2>🧠 Mood Score</h2>
    <form hx-post="/mood" hx-trigger="change" hx-target="this" hx-swap="none">
      <input type="range" name="score" min="1" max="5" x-model="mood">
      <output x-text="mood" style="margin-left: 0.5em;"></output>
    </form>
  </section>

  <!-- Modal -->
  <div class="modal" x-show="showModal" style="display: none;" @keydown.escape.window="showModal = false">
    <div class="modal-content" @click.outside="showModal = false">
      <h3 x-text="form.label"></h3>
      <form :action="`/log/${form.habit}`" method="post" hx-post hx-target="#habit-grid" hx-swap="outerHTML" @submit="
        localStorage.setItem(`${form.habit}_duration`, form.duration);
        localStorage.setItem(`${form.habit}_note`, form.note);
        showModal = false
      ">
        <label>Duration (minutes):</label>
        <input type="number" name="duration" x-model="form.duration" min="1" required>
        <label>Note:</label>
        <input type="text" name="note" x-model="form.note" placeholder="Optional note">
        <div class="modal-actions">
          <button type="submit">✅ Save</button>
          <button type="button" @click="showModal = false">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
