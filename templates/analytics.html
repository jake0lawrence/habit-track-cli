<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>üìä Analytics ‚Äì habit-track</title>
  <script src="{{ url_for('static', filename='chart.min.js') }}"></script>
  <script src="{{ url_for('static', filename='alpine.min.js') }}" defer></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

  {% if config.PWA_ENABLED %}
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/static/service-worker.js");
      }
    </script>
  {% endif %}

  <link rel="icon" type="image/svg+xml" href="/static/icons/icon.svg">
</head>

<body x-data="{ dark: JSON.parse(localStorage.getItem('darkMode') || 'false') }"
      x-init="$watch('dark', val => localStorage.setItem('darkMode', val))"
      :class="{ 'dark': dark }">

  {% if debug %}
  <div class="debug-banner">
    DEBUG MODE ON | Dark: <span x-text="dark"></span> | PWA: {{ config.PWA_ENABLED }}
  </div>
  {% endif %}

  <header>
    <h1>üìà Analytics</h1>
    <div class="controls">
      <a href="/" class="button">‚Üê Back</a>
      <button @click="dark = !dark" class="theme-toggle" x-text="dark ? 'üåó Light Mode' : 'üåë Dark Mode'"></button>
    </div>
  </header>

  <section>
    {% for chart in chart_data %}
      <div class="chart-block">
        <h3>{{ chart.label }}</h3>
        <canvas id="chart-{{ loop.index }}"></canvas>
        <script>
          new Chart(document.getElementById("chart-{{ loop.index }}"), {
            type: 'bar',
            data: {
              labels: {{ labels | tojson }},
              datasets: [{
                label: '{{ chart.label }}',
                data: {{ chart.data | tojson }},
                backgroundColor: '#42b983'
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(ctx) {
                      return `Duration: ${ctx.raw} min`;
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  title: { display: true, text: 'Minutes' }
                }
              }
            }
          });
        </script>
      </div>
    {% endfor %}

    <div class="chart-block">
      <h3>Mood Over Time</h3>
      <canvas id="mood-chart"></canvas>
      <script>
        const moodSeries = {{ mood_series | tojson }};
        const ctx = document.getElementById('mood-chart').getContext('2d');
        const lineColor = document.body.classList.contains('dark') ? '#ffffff' : '#222222';
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: moodSeries.map(p => p.date),
            datasets: [{
              label: 'Mood',
              data: moodSeries.map(p => p.score),
              tension: 0.3,
              fill: false,
              borderColor: lineColor,
              backgroundColor: lineColor
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true, max: 5 } },
            plugins: { legend: { display: false } }
          }
        });
      </script>
    </div>
  </section>
</body>
</html>